from pyspark.sql.window import Window
from pyspark.sql import functions as F

# Define a window partitioned by user, ordered by total engagement
w_brand = Window.partitionBy("user_id", "brandName").orderBy(F.col("total").desc())

# Add brand_rank column
df_final = df_final.withColumn("brand_rank", F.rank().over(w_brand))




from pyspark.sql.window import Window
from pyspark.sql import functions as F

# Define window per user and category total engagement
w_cat = Window.partitionBy("user_id").orderBy(F.col("total").desc())

# Add category_rank per user
df_final = df_final.withColumn("category_rank", F.rank().over(w_cat))




# Define window per user and subcategory total engagement
w_subcat = Window.partitionBy("user_id").orderBy(F.col("total").desc())

# Add subcategory_rank per user
df_final = df_final.withColumn("subcategory_rank", F.rank().over(w_subcat))
